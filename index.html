<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="An immersive, interactive map exploring 5 magical experiences in Manali, from the snowy lanes of Old Manali to the spiritual calm of Hidimba Temple.">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' 'unsafe-inline' https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://unpkg.com https://fonts.googleapis.com; 
        img-src 'self' data: https://*.basemaps.cartocdn.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://*.basemaps.cartocdn.com;
    ">

    <title>Manali: A Soulful Journey</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous"/>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500&family=Playfair+Display:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette: Deep Midnight - Refined */
            --bg-deep: #050507;
            --text-primary: #FFFFFF;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.4);

            /* Sophisticated Gold - Metallic */
            --accent-gold: #E5C07B;
            --accent-gold-light: #F7E0A3;
            --accent-glow: rgba(229, 192, 123, 0.15);

            /* Glassmorphism - Ultrathink Polish */
            --glass-bg: rgba(5, 5, 7, 0.6);
            --glass-border: rgba(255, 255, 255, 0.06);
            --glass-highlight: rgba(255, 255, 255, 0.04);
            --glass-shadow:
                0 40px 80px -12px rgba(0, 0, 0, 0.9),
                0 16px 32px -8px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(255, 255, 255, 0.06);

            --font-heading: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;

            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-in-out: cubic-bezier(0.65, 0, 0.35, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            overflow: hidden; background-color: var(--bg-deep);
            font-family: var(--font-body);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
        }

        /* Vignette Overlay for Focus */
        body::before {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, transparent 20%, rgba(0,0,0,0.6) 100%);
            pointer-events: none;
            z-index: 4;
        }

        /* Noise Texture Overlay */
        body::after {
            content: "";
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 5;
            mix-blend-mode: overlay;
        }

        ::selection {
            background: rgba(197, 160, 89, 0.3);
            color: #fff;
        }

        #map {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            background: var(--bg-deep);
            transition: filter 1.2s var(--ease-in-out);
        }

        body.has-active-story #map {
            filter: brightness(0.5) contrast(1.1) saturation(0.7) blur(1px);
        }

        /* UI Container */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            pointer-events: none;
            display: flex; flex-direction: column;
        }

        /* Header */
        header {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 32px 24px;
            text-align: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
            transition: opacity 0.8s var(--ease-out-expo);
            z-index: 20;
        }

        h1 {
            font-family: var(--font-heading);
            font-weight: 400;
            font-size: 2.2rem;
            margin: 0;
            color: var(--text-primary);
            letter-spacing: -0.01em;
            text-shadow: 0 4px 30px rgba(0,0,0,0.7);
        }

        /* Start Button - Refined */
        #start-btn {
            position: absolute;
            bottom: max(40px, env(safe-area-inset-bottom) + 32px);
            left: 50%;
            transform: translateX(-50%);
            animation: fadeUp 1.2s var(--ease-out-expo) 0.2s backwards;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px 56px;
            border-radius: 200px;
            font-family: var(--font-body);
            font-weight: 300;
            font-size: 0.95rem;
            white-space: nowrap;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
            transition: all 0.6s var(--ease-out-expo);
            pointer-events: auto;
            z-index: 10;
            overflow: hidden;
        }

        #start-btn::before {
            content: '';
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: translateX(-100%);
            transition: transform 0.6s ease;
        }

        #start-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateX(-50%) scale(1.02);
            box-shadow: 0 20px 60px -12px rgba(0,0,0,0.6), 0 0 30px rgba(255,255,255,0.05);
        }

        #start-btn:active {
            transform: translateX(-50%) scale(0.98);
        }
        
        #start-btn:hover::before { opacity: 1; }

        body.has-active-story #start-btn {
            opacity: 0; pointer-events: none; transform: translateX(-50%) translateY(40px);
        }

        body.has-active-story header {
            opacity: 0; pointer-events: none;
        }

        /* Story Card - Mobile (Bottom Sheet - Optimized) */
        #story-card {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(32px) saturate(180%);
            -webkit-backdrop-filter: blur(32px) saturate(180%);
            border-top: 1px solid var(--glass-border);
            border-radius: 32px 32px 0 0;
            padding: 32px 24px max(32px, env(safe-area-inset-bottom) + 24px);
            box-shadow: 0 -20px 60px rgba(0,0,0,0.5);
            transform: translateY(110%);
            transition: transform 0.8s var(--ease-spring), opacity 0.6s ease;
            pointer-events: auto;
            max-height: 80vh;
            overflow-y: auto;
            display: flex; flex-direction: column;
            overscroll-behavior: contain;
        }

        /* Custom Scrollbar */
        #story-card::-webkit-scrollbar { width: 4px; }
        #story-card::-webkit-scrollbar-track { background: transparent; }
        #story-card::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
        #story-card::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }

        /* Subtle gradient overlay on card */
        #story-card::after {
            content: '';
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at top right, rgba(255,255,255,0.03), transparent 60%);
            pointer-events: none;
            border-radius: 32px 32px 0 0;
        }

        #story-card.visible {
            transform: translateY(0);
        }

        .card-handle {
            width: 40px; height: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            margin: 0 auto 32px;
            cursor: grab;
            transition: all 0.3s ease;
            flex-shrink: 0;
            z-index: 2;
        }

        .card-handle::before {
            content: '';
            position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 100px; height: 40px;
            cursor: inherit;
        }

        .card-handle:active {
            cursor: grabbing;
            width: 50px;
            background: rgba(255,255,255,0.3);
        }

        .story-content {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease, transform 0.5s var(--ease-out-expo);
            position: relative; z-index: 2;
        }
        
        .story-content.fade-out {
            opacity: 0;
            transform: translateY(15px);
        }

        #story-card h2 {
            font-family: var(--font-heading);
            font-weight: 400;
            font-size: 2.4rem;
            color: var(--text-primary);
            margin: 0 0 20px 0;
            line-height: 1.05;
            letter-spacing: -0.02em;
            text-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        #story-card p {
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.7;
            margin: 0 0 40px 0;
            font-weight: 300;
            letter-spacing: 0.01em;
            max-width: 90%;
        }

        /* Navigation Controls inside Card */
        .card-nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: auto;
            padding-top: 24px;
            border-top: 1px solid rgba(255,255,255,0.04);
            z-index: 2;
        }

        .nav-btn {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-primary);
            width: 56px; height: 56px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.4s var(--ease-spring);
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .nav-btn:active:not(:disabled) {
            transform: scale(0.95);
        }
        
        .nav-btn:disabled {
            opacity: 0.2; cursor: default; border-color: transparent;
        }

        .progress-dots {
            display: flex; gap: 12px;
        }

        .dot {
            width: 6px; height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.6s var(--ease-out-expo);
        }

        .dot.active {
            background: var(--accent-gold);
            box-shadow: 0 0 12px var(--accent-glow);
            transform: scale(1.5);
        }

        /* Desktop Styles - Ultrathink Polish */
        @media (min-width: 1024px) {
            #story-card {
                position: absolute;
                top: 50%; left: 120px; bottom: auto; right: auto;
                transform: translateY(-50%) translateX(-20px);
                opacity: 0;
                width: 480px;
                border-radius: 24px;
                border: 1px solid var(--glass-border);
                padding: 72px 64px;
                max-height: 85vh;
                backdrop-filter: blur(60px) saturate(200%);
                -webkit-backdrop-filter: blur(60px) saturate(200%);
                box-shadow: var(--glass-shadow);
                transition: all 0.9s var(--ease-out-expo);
            }

            #story-card::after { border-radius: 24px; }

            #story-card.visible {
                transform: translateY(-50%) translateX(0);
                opacity: 1;
            }

            header {
                text-align: left;
                padding: 64px 120px;
                background: none;
                pointer-events: none;
            }

            h1 {
                font-size: 4.5rem;
                font-weight: 300; /* Ultra-thin feel */
                letter-spacing: -0.03em;
                line-height: 1.05;
                color: var(--text-primary);
                max-width: 700px;
                text-shadow: 0 20px 60px rgba(0,0,0,0.8);
                mix-blend-mode: normal;
            }

            .card-handle { display: none; }

            #start-btn {
                bottom: 120px; left: 120px; transform: translateX(0);
                padding: 24px 64px;
                font-size: 0.95rem;
                letter-spacing: 0.2em;
                background: rgba(255, 255, 255, 0.02);
                border-color: rgba(255,255,255,0.08);
            }

            #start-btn:hover {
                transform: translateX(0) scale(1.01);
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255,255,255,0.2);
                box-shadow: 0 30px 60px -10px rgba(0,0,0,0.7);
            }

            body.has-active-story #start-btn {
                 transform: translateX(-20px);
                 opacity: 0;
            }

            .marker-tooltip {
                font-size: 0.85rem;
                padding: 8px 16px;
                background: rgba(5, 5, 8, 0.9);
                backdrop-filter: blur(16px);
                border: 1px solid rgba(255,255,255,0.08);
                box-shadow: 0 10px 40px rgba(0,0,0,0.6);
                font-family: var(--font-body);
                font-weight: 300;
                letter-spacing: 0.05em;
            }

            .close-btn {
                top: 40px; right: 40px;
            }
        }

        /* Close Button */
        .close-btn {
            position: absolute; top: 24px; right: 24px;
            background: rgba(255,255,255,0.05); border: 1px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            width: 44px; height: 44px; border-radius: 50%; /* Larger touch target */
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .close-btn:hover {
            color: var(--text-primary);
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.2);
            transform: rotate(90deg);
        }
        .close-btn:active {
            transform: scale(0.9);
        }

        /* Map Markers */
        .custom-marker {
            width: 12px; height: 12px;
            background: var(--text-primary);
            border-radius: 50%;
            transition: all 0.6s var(--ease-out-expo);
            cursor: pointer;
        }
        
        .custom-marker::after {
            content: '';
            position: absolute; top: 50%; left: 50%;
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 1px solid var(--text-primary);
            transform: translate(-50%, -50%) scale(1.4);
            opacity: 0.5;
            transition: all 0.5s ease;
        }

        .custom-marker:hover {
            transform: scale(1.5);
            background: var(--accent-gold);
            box-shadow: 0 0 20px var(--accent-glow);
        }
        .custom-marker:hover::after {
            transform: translate(-50%, -50%) scale(2.5);
            opacity: 0;
            border-color: var(--accent-gold);
        }

        .custom-marker.active {
            background: var(--accent-gold);
            transform: scale(1.5);
            box-shadow: 0 0 30px var(--accent-glow);
            z-index: 1000 !important;
        }

        .custom-marker.active::after {
            display: none;
        }

        /* Pulse Ring for Active */
        .custom-marker.active::before {
            content: '';
            position: absolute; top: 50%; left: 50%;
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 1px solid var(--accent-gold);
            transform: translate(-50%, -50%);
            animation: pulse-ring 2s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
        }

        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(5); opacity: 0; }
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @media (min-width: 1024px) {
            @keyframes fadeUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }

        /* Tooltip */
        .marker-tooltip {
            position: absolute;
            bottom: 28px; left: 50%;
            transform: translateX(-50%) translateY(10px);
            background: rgba(10, 10, 15, 0.95);
            color: #fff;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s var(--ease-out-expo);
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            letter-spacing: 0.02em;
        }

        .custom-marker:hover .marker-tooltip {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        *:focus-visible {
            outline: 2px solid var(--accent-gold);
            outline-offset: 4px;
        }
        .sr-only {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px;
            overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0;
        }

        /* --- New Enrichment Styles --- */

        .story-card-hero {
            display: block;
            width: calc(100% + 48px);
            height: 200px;
            background-size: cover;
            background-position: center;
            margin: -32px -24px 24px -24px;
            border-radius: 32px 32px 0 0;
            mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%);
            background-color: #1a1a1a; /* Placeholder color */
            transition: background-image 0.5s ease;
        }

        .meta-row {
            display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 20px;
            font-size: 0.75rem; color: var(--accent-gold);
            font-weight: 600; letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        .meta-item { display: flex; align-items: center; gap: 6px; }

        .pro-tip {
            background: rgba(229, 192, 123, 0.08);
            border-left: 2px solid var(--accent-gold);
            padding: 16px 20px;
            margin-top: 32px;
            border-radius: 0 12px 12px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.6;
        }

        .pro-tip strong { color: var(--accent-gold-light); font-style: normal; margin-right: 6px; }

        /* Map Controls */
        .map-controls {
            position: absolute; bottom: max(32px, env(safe-area-inset-bottom) + 32px); right: 24px;
            display: flex; flex-direction: column; gap: 12px;
            z-index: 1000;
        }

        .control-btn, .about-btn {
            width: 48px; height: 48px;
            background: rgba(5, 5, 7, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 14px;
            color: var(--text-primary);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            pointer-events: auto;
        }

        .control-btn:hover, .about-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .control-btn:active, .about-btn:active { transform: scale(0.95); }

        /* About Button Position */
        .about-btn {
            position: absolute; top: 32px; left: 24px;
            z-index: 1000;
        }

        /* About Modal */
        .about-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(12px);
            z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .about-modal[aria-hidden="false"] {
            opacity: 1; pointer-events: auto;
        }

        .modal-content {
            background: rgba(10, 10, 15, 0.9);
            border: 1px solid var(--glass-border);
            padding: 40px;
            border-radius: 24px;
            max-width: 460px; width: 85%;
            text-align: center;
            position: relative;
            transform: translateY(20px) scale(0.95);
            transition: all 0.5s var(--ease-out-expo);
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }

        .about-modal[aria-hidden="false"] .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-content h2 {
            font-family: var(--font-heading);
            color: var(--accent-gold);
            font-size: 2rem;
            margin-top: 0;
            margin-bottom: 16px;
        }

        .modal-content p {
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .close-modal {
            position: absolute; top: 16px; right: 16px;
            background: none; border: none; color: var(--text-muted);
            cursor: pointer; padding: 8px;
            transition: color 0.3s ease;
            display: flex;
        }
        .close-modal:hover { color: #fff; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .story-card-hero { height: 180px; }
            .map-controls { bottom: max(100px, env(safe-area-inset-bottom) + 100px); }

            /* Adjust header to not overlap with button */
            header { padding-top: 80px; }

            /* Move start button up slightly to clear bottom controls if needed, but controls are right-aligned */
        }

        @media (min-width: 1024px) {
            .story-card-hero {
                border-radius: 24px 24px 0 0;
                margin: -72px -64px 32px -64px;
                width: calc(100% + 128px);
                height: 260px;
            }
            .about-btn { top: 40px; left: 40px; width: 56px; height: 56px; }
            .map-controls { right: 40px; bottom: 40px; }
        }

        /* Enriched Content Styles */
        .audio-cue, .getting-there {
            display: flex; align-items: center; gap: 12px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .audio-cue svg, .getting-there svg {
            color: var(--accent-gold);
            flex-shrink: 0;
        }

        .favorite-btn .heart-icon {
            transition: all 0.3s var(--ease-spring);
        }

        .favorite-btn.active .heart-icon {
            fill: var(--accent-gold);
            stroke: var(--accent-gold);
            transform: scale(1.1);
        }

        /* Quick Guide Styles */
        .quick-guide {
            display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
            margin-top: 32px; padding-top: 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .guide-item {
            display: flex; flex-direction: column; gap: 12px;
        }

        .guide-icon {
            width: 40px; height: 40px;
            background: rgba(229, 192, 123, 0.1);
            border: 1px solid rgba(229, 192, 123, 0.2);
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--accent-gold);
            margin-bottom: 4px;
        }

        .guide-item h4 {
            margin: 0 0 6px 0;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            font-weight: 500;
        }

        .guide-item p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        @media (max-width: 600px) {
            .quick-guide { grid-template-columns: 1fr; gap: 24px; }
            .guide-item { flex-direction: row; align-items: flex-start; }
            .guide-icon { flex-shrink: 0; margin-bottom: 0; }
        }

        /* Toast Notification */
        #toast {
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: var(--accent-gold);
            color: #050507;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 500;
            font-size: 0.9rem;
            box-shadow: 0 10px 40px rgba(229, 192, 123, 0.3);
            z-index: 3000;
            opacity: 0;
            transition: all 0.5s var(--ease-spring);
            pointer-events: none;
        }

        #toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Filter Styles */
        #filter-container {
            position: absolute;
            top: 100px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 8px;
            padding: 0 24px;
            z-index: 15;
            pointer-events: auto;
            overflow-x: auto;
            scrollbar-width: none;
        }

        #filter-container::-webkit-scrollbar { display: none; }

        .filter-chip {
            background: rgba(5, 5, 7, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            backdrop-filter: blur(12px);
            font-family: var(--font-body);
        }

        .filter-chip:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .filter-chip.active {
            background: var(--accent-gold);
            color: #050507;
            border-color: var(--accent-gold);
            font-weight: 500;
            box-shadow: 0 0 15px rgba(229, 192, 123, 0.3);
        }

        @media (min-width: 1024px) {
            #filter-container {
                top: auto; bottom: 40px; left: 40px;
                width: auto;
                justify-content: flex-start;
                padding: 0;
            }
        }

        /* Weather Widget Styles */
        #weather-widget {
            position: absolute;
            top: 32px; right: 24px;
            display: flex; align-items: center; gap: 12px;
            padding: 12px 20px;
            background: rgba(5, 5, 7, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            color: var(--text-primary);
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: fadeIn 1.5s ease 0.5s backwards;
        }

        .weather-info {
            display: flex; flex-direction: column;
            line-height: 1.2;
        }

        #weather-temp {
            font-weight: 500;
            font-size: 1.1rem;
        }

        #weather-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (min-width: 1024px) {
            #weather-widget { top: 40px; right: 40px; }
        }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="toast">Link Copied</div>
    <div id="ui-layer">
        <header>
            <h1>Manali: A Soulful Journey</h1>
        </header>

        <div id="filter-container">
            <button class="filter-chip active" onclick="filterMarkers('All')">All</button>
            <button class="filter-chip" onclick="filterMarkers('Nature')">Nature</button>
            <button class="filter-chip" onclick="filterMarkers('Adventure')">Adventure</button>
            <button class="filter-chip" onclick="filterMarkers('Culture')">Culture</button>
            <button class="filter-chip" onclick="filterMarkers('Relaxation')">Relaxation</button>
        </div>

        <button id="start-btn" onclick="showExperience(0)">Start the Journey</button>

        <div id="weather-widget">
            <div class="weather-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17.5 19c0-1.7-1.3-3-3-3h-5c-1.7 0-3 1.3-3 3s1.3 3 3 3h5c1.7 0 3-1.3 3-3z"></path><path d="M17.5 19a6 6 0 1 0-8.4-8"></path><path d="M16 9l2-2"></path><path d="M9 10l-2-2"></path></svg>
            </div>
            <div class="weather-info">
                <span id="weather-temp">-2°C</span>
                <span id="weather-desc">Mist</span>
            </div>
        </div>

        <div class="map-controls">
            <button class="control-btn" onclick="map.zoomIn()" aria-label="Zoom In">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 5v14M5 12h14"/></svg>
            </button>
            <button class="control-btn" onclick="map.zoomOut()" aria-label="Zoom Out">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M5 12h14"/></svg>
            </button>
            <button class="control-btn" onclick="resetMap()" aria-label="Reset Map">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
        </div>

        <button class="about-btn" onclick="toggleAbout()" aria-label="About">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
        </button>

        <div id="about-modal" class="about-modal" aria-hidden="true">
            <div class="modal-content">
                <button class="close-modal" onclick="toggleAbout()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M18 6L6 18M6 6l12 12"/></svg>
                </button>
                <h2>About Manali Trance</h2>
                <p>An interactive tribute to the soul of the Himalayas. Explore the hidden gems, quiet corners, and golden moments of Manali.</p>
                <p style="margin-top: 16px; font-size: 0.85rem; color: var(--text-muted);">Curated with love. <br>Images from Unsplash.</p>
            </div>
        </div>

        <article id="story-card" aria-live="polite">
            <button class="close-btn" aria-label="Close story" onclick="closeStory()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <div class="card-handle"></div>

            <div id="story-hero-img" class="story-card-hero" role="img" aria-label="Story Image"></div>

            <div class="story-content" id="story-content-wrapper">
                <div class="meta-row">
                    <span class="meta-item" id="meta-category"></span>
                    <span class="meta-item" id="meta-time">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                        <span id="story-time"></span>
                    </span>
                    <span class="meta-item" id="meta-vibe" style="color: var(--text-primary); opacity: 0.8;"></span>
                </div>

                <h2 id="story-title">Experience Title</h2>
                <p id="story-description">Description goes here...</p>

                <div class="audio-cue">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h5l4 8V4L7 12H2z"></path></svg>
                    <span id="story-audio"></span>
                </div>

                <div class="getting-there">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
                    <strong>Getting There:</strong> <span id="story-location"></span>
                </div>

                <div class="pro-tip">
                    <strong>Pro Tip:</strong> <span id="story-tip"></span>
                </div>

                <div class="quick-guide">
                    <div class="guide-item">
                        <span class="guide-icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg>
                        </span>
                        <div>
                            <h4>Local Lore</h4>
                            <p id="story-lore"></p>
                        </div>
                    </div>
                    <div class="guide-item">
                        <span class="guide-icon">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                        </span>
                        <div>
                            <h4>Packing Essentials</h4>
                            <p id="story-packing"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-nav">
                <button class="nav-btn" id="prev-btn" onclick="navigate(-1)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M15 18l-6-6 6-6"/></svg>
                    <span class="sr-only">Previous</span>
                </button>

                <div class="progress-dots" id="progress-dots"></div>

                <button class="nav-btn" id="favorite-btn" onclick="toggleFavorite(currentIndex)" aria-label="Favorite">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="heart-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                </button>

                <button class="nav-btn" id="share-btn" onclick="shareExperience()" aria-label="Share">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>
                </button>

                <button class="nav-btn" id="next-btn" onclick="navigate(1)">
                     <span class="sr-only">Next</span>
                     <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>
        </article>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
    <script>
        const experiences = [
            {
                title: "Symphony of Snow",
                description: "Step outside your wooden cottage in Old Manali. The Himalayan peaks shimmer in the early light, draped in fresh snow. The only sounds are the crunch of snow and the distant Beas River. It feels like the world has paused—just for you.",
                coords: [32.2513, 77.1843],
                zoom: 15,
                image: "https://images.unsplash.com/photo-1519681393784-d120267933ba?auto=format&fit=crop&w=800&q=80",
                tips: "Wear layers; mornings are freezing.",
                bestTime: "Sunrise (6:00 AM)",
                category: "Nature",
                audioCue: "Crunch of fresh snow, distant river flow",
                gettingThere: "15 min walk from Old Manali bridge",
                vibeTag: "Serene",
                localLore: "Old Manali was once a quiet village, now a bridge between eras.",
                packingList: "Thermal wear, Woolen socks, Beanie"
            },
            {
                title: "Golden Solang",
                description: "As the sun begins its descent, Solang Valley transforms into a golden dreamscape. The white expanse reflects amber and violet hues. You watch paragliders soar like birds in slow motion, silhouetted against the kaleidoscope. A moment that demands stillness.",
                coords: [32.3218, 77.1587],
                zoom: 14,
                image: "https://images.unsplash.com/photo-1504280390367-361c6d9e6342?auto=format&fit=crop&w=800&q=80",
                tips: "Book paragliding in advance to skip queues.",
                bestTime: "Sunset (5:30 PM)",
                category: "Adventure",
                audioCue: "Wind whistling, faint laughter of paragliders",
                gettingThere: "30 min drive from Manali center",
                vibeTag: "Thrilling",
                localLore: "Historically a grazing ground for shepherds before becoming a ski paradise.",
                packingList: "Sunglasses, Sunscreen, Windbreaker"
            },
            {
                title: "Whispering Hamta",
                description: "With every step into the pine-laced trails, the modern world dissolves. The forest speaks in rustles and hushes, sunlight filtering through tall trees like shards of gold. You pause to breathe it in—damp earth, mountain mist, the quiet thrill of discovery.",
                coords: [32.2981, 77.2796],
                zoom: 13,
                image: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?auto=format&fit=crop&w=800&q=80",
                tips: "Carry water and sturdy shoes.",
                bestTime: "Afternoon (2:00 PM)",
                category: "Nature",
                audioCue: "Rustling pine needles, bird calls",
                gettingThere: "1 hr trek from Jobra base",
                vibeTag: "Wild",
                localLore: "The pass connects the lush Kullu valley to the arid Lahaul.",
                packingList: "Hiking boots, Raincoat, Energy bars"
            },
            {
                title: "Rooftop Chai",
                description: "Perched on a rooftop in Vashisht, cup of steaming masala chai warming your hands, you watch clouds dance over snow-dusted ridges. The smell of cinnamon and woodsmoke fills the air. Every sip feels like a quiet celebration of life.",
                coords: [32.2571, 77.1883],
                zoom: 16,
                image: "https://images.unsplash.com/photo-1511920170033-f8396924c348?auto=format&fit=crop&w=800&q=80",
                tips: "Try the local honey ginger lemon tea.",
                bestTime: "Evening (4:00 PM)",
                category: "Relaxation",
                audioCue: "Steam hissing, chatter, acoustic guitar",
                gettingThere: "In Vashisht market square",
                vibeTag: "Cozy",
                localLore: "Vashisht is named after the sage Vashistha, one of the Saptarishis.",
                packingList: "Cash (small bills), Shawl"
            },
            {
                title: "Sacred Silence",
                description: "Tucked inside an ancient forest of towering deodars, Hidimba Temple feels like a portal. Its wooden pagoda architecture rises from the mossy ground. You hear the wind sigh through the trees, mingling with a distant chant. A sacred quiet that grounds you.",
                coords: [32.2471, 77.1804],
                zoom: 17,
                image: "https://images.unsplash.com/photo-1599420186946-7b6fb4e297f0?auto=format&fit=crop&w=800&q=80",
                tips: "Respect the silence; it’s a living temple.",
                bestTime: "Early Morning (7:00 AM)",
                category: "Culture",
                audioCue: "Temple bells, wind in deodar trees",
                gettingThere: "10 min walk from Mall Road",
                vibeTag: "Spiritual",
                localLore: "Dedicated to Hidimba Devi, wife of Bhima from the Mahabharata.",
                packingList: "Modest clothing, Slip-on shoes"
            },
            {
                title: "Sacred Cascade",
                description: "A trek through apple orchards and pine forests leads you to the thundering Jogini Waterfalls. The spray kisses your face as you stand before the sacred stream, believed to be the bathing place of the Goddess Jogini. Rainbows often dance in the mist.",
                coords: [32.2620, 77.1990],
                zoom: 15,
                image: "https://images.unsplash.com/photo-1626621341517-bbf3d9990a23?auto=format&fit=crop&w=800&q=80",
                tips: "Start early to avoid the midday sun.",
                bestTime: "Morning (10:00 AM)",
                category: "Nature",
                audioCue: "Roaring water, chirping crickets",
                gettingThere: "30 min trek from Vashisht Temple",
                vibeTag: "Majestic",
                localLore: "Villagers believe the stream is protected by guardians.",
                packingList: "Water bottle, Good grip shoes, Towel"
            },
            {
                title: "River Rhythms",
                description: "Sitting by the Manalsu River, the music from the cafes blends with the rushing water. It's the meeting point of travelers from around the world. The air smells of wood-fired pizza and freedom.",
                coords: [32.2530, 77.1760],
                zoom: 16,
                image: "https://images.unsplash.com/photo-1598612781491-9e419b493155?auto=format&fit=crop&w=800&q=80",
                tips: "Grab a table by the window.",
                bestTime: "Sunset (6:00 PM)",
                category: "Relaxation",
                audioCue: "Live jazz, rushing river, laughter",
                gettingThere: "Main road, Old Manali",
                vibeTag: "Bohemian",
                localLore: "Named after the year of India's independence, symbolizing freedom.",
                packingList: "Journal, Camera, Warm jacket"
            }
        ];

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([32.28, 77.18], 12);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        let currentIndex = -1;
        let markers = [];

        const storyCard = document.getElementById('story-card');
        const titleEl = document.getElementById('story-title');
        const descEl = document.getElementById('story-description');
        const dotsContainer = document.getElementById('progress-dots');
        const contentWrapper = document.getElementById('story-content-wrapper');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // New Elements
        const heroImg = document.getElementById('story-hero-img');
        const metaCategory = document.getElementById('meta-category');
        const metaTime = document.getElementById('story-time');
        const metaTip = document.getElementById('story-tip');
        const metaVibe = document.getElementById('meta-vibe');
        const storyAudio = document.getElementById('story-audio');
        const storyLocation = document.getElementById('story-location');
        const storyLore = document.getElementById('story-lore');
        const storyPacking = document.getElementById('story-packing');
        const favBtn = document.getElementById('favorite-btn');
        const aboutModal = document.getElementById('about-modal');

        // Initialize Markers, Dots, and Polyline
        const routeCoords = experiences.map(exp => exp.coords);
        const routeLine = L.polyline(routeCoords, {
            color: '#E5C07B',
            dashArray: '8, 16',
            weight: 2,
            opacity: 0.4,
            lineCap: 'round'
        }).addTo(map);

        experiences.forEach((exp, i) => {
            const icon = L.divIcon({
                className: 'custom-marker',
                html: `<span class="sr-only">${exp.title}</span><div class="marker-tooltip">${exp.title}</div>`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            const marker = L.marker(exp.coords, { icon: icon }).addTo(map);
            marker.on('click', () => showExperience(i));

            const el = marker.getElement();
            if(el) {
                el.tabIndex = 0;
                el.role = "button";
                el.ariaLabel = exp.title;
                el.addEventListener('keydown', e => {
                    if (e.key === 'Enter' || e.key === ' ') showExperience(i);
                });
            }

            markers.push(marker);

            const dot = document.createElement('div');
            dot.className = 'dot';
            dotsContainer.appendChild(dot);
        });

        function updateNavState() {
            prevBtn.disabled = currentIndex <= 0;
            nextBtn.disabled = currentIndex >= experiences.length - 1;
            Array.from(dotsContainer.children).forEach((dot, i) => {
                dot.classList.toggle('active', i === currentIndex);
            });
        }

        function showExperience(index) {
            if (index < 0 || index >= experiences.length) return;
            
            document.body.classList.add('has-active-story');
            const isFirstLoad = currentIndex === -1;
            currentIndex = index;
            const exp = experiences[index];

            // Smoother flyTo
            map.flyTo(exp.coords, exp.zoom, {
                animate: true,
                duration: 1.2,
                easeLinearity: 0.1
            });

            if (!isFirstLoad && storyCard.classList.contains('visible')) {
                // Staggered text animation
                contentWrapper.classList.add('fade-out');
                setTimeout(() => {
                    updateContent(exp, index);
                    contentWrapper.classList.remove('fade-out');
                }, 400);
            } else {
                updateContent(exp, index);
                storyCard.classList.add('visible');
            }

            markers.forEach((m, i) => {
                const el = m.getElement();
                if (i === index) {
                    el.classList.add('active');
                    m.setZIndexOffset(1000);
                } else {
                    el.classList.remove('active');
                    m.setZIndexOffset(0);
                }
            });

            updateNavState();
        }

        function updateContent(exp, idx) {
            titleEl.textContent = exp.title;
            descEl.textContent = exp.description;

            // New Content
            metaCategory.textContent = exp.category;
            metaTime.textContent = exp.bestTime;
            metaTip.textContent = exp.tips;

            // Enriched Content
            metaVibe.textContent = exp.vibeTag;
            storyAudio.textContent = exp.audioCue;
            storyLocation.textContent = exp.gettingThere;
            storyLore.textContent = exp.localLore;
            storyPacking.textContent = exp.packingList;

            // Handle Image
            heroImg.style.backgroundImage = `url('${exp.image}')`;

            // Update Favorite State
            const favorites = JSON.parse(localStorage.getItem('manali_favs') || '[]');
            if (favorites.includes(idx)) {
                favBtn.classList.add('active');
            } else {
                favBtn.classList.remove('active');
            }
        }

        function navigate(dir) {
            showExperience(currentIndex + dir);
        }
        
        function closeStory() {
            document.body.classList.remove('has-active-story');
            storyCard.classList.remove('visible');
            currentIndex = -1;
            markers.forEach((m) => {
                m.getElement().classList.remove('active');
                m.setZIndexOffset(0);
            });
            map.flyTo([32.28, 77.18], 12, { duration: 1.5 });
        }

        // --- New Logic: Controls & Modal ---

        function filterMarkers(category) {
            // Update Chips
            document.querySelectorAll('.filter-chip').forEach(btn => {
                if (btn.textContent === category) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // Update Markers
            let visibleBounds = L.latLngBounds();
            let hasVisible = false;

            experiences.forEach((exp, i) => {
                const marker = markers[i];
                if (category === 'All' || exp.category === category) {
                    if (!map.hasLayer(marker)) marker.addTo(map);
                    visibleBounds.extend(exp.coords);
                    hasVisible = true;
                } else {
                    if (map.hasLayer(marker)) map.removeLayer(marker);
                }
            });

            // Update Route Line
            if (category === 'All') {
                if (!map.hasLayer(routeLine)) routeLine.addTo(map);
            } else {
                if (map.hasLayer(routeLine)) map.removeLayer(routeLine);
            }

            // Optional: Fit bounds if filters change?
            // Maybe not, as it might be jarring. But users expect to see the results.
            if (hasVisible && category !== 'All') {
                 map.flyToBounds(visibleBounds, { padding: [50, 50], duration: 1.5 });
            } else if (category === 'All') {
                 map.flyTo([32.28, 77.18], 12, { duration: 1.5 });
            }

            closeStory(); // Close any open story when filtering to avoid confusion
        }

        function toggleFavorite(idx) {
            if (idx === -1) return;
            let favorites = JSON.parse(localStorage.getItem('manali_favs') || '[]');

            if (favorites.includes(idx)) {
                favorites = favorites.filter(i => i !== idx);
                favBtn.classList.remove('active');
            } else {
                favorites.push(idx);
                favBtn.classList.add('active');

                // Slight animation feedback
                favBtn.style.transform = "scale(1.2)";
                setTimeout(() => favBtn.style.transform = "", 200);
            }

            localStorage.setItem('manali_favs', JSON.stringify(favorites));
        }

        function shareExperience() {
            if (currentIndex === -1) return;
            const exp = experiences[currentIndex];
            const text = `Discover "${exp.title}" in Manali: ${exp.description} - via Manali Trance`;

            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById('toast');
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        function loadFavorites() {
            // Could use this to initialize map markers if needed
        }

        function updateWeather() {
            const temps = [-5, -3, 0, 2, 5];
            const conds = ["Mist", "Snow", "Clear", "Cloudy"];
            const temp = temps[Math.floor(Math.random() * temps.length)];
            const cond = conds[Math.floor(Math.random() * conds.length)];

            document.getElementById('weather-temp').textContent = `${temp}°C`;
            document.getElementById('weather-desc').textContent = cond;
        }

        // Init
        loadFavorites();
        updateWeather();

        function resetMap() {
            closeStory();
        }

        function toggleAbout() {
            const isHidden = aboutModal.getAttribute('aria-hidden') === 'true';
            aboutModal.setAttribute('aria-hidden', !isHidden);
        }

        // Close modal on outside click
        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) toggleAbout();
        });

        // --- Swipe Gestures for Mobile ---
        let touchStartX = 0;
        let touchEndX = 0;
        const swipeThreshold = 50;

        storyCard.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        storyCard.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    // Swiped Left -> Next
                    if (currentIndex < experiences.length - 1) navigate(1);
                } else {
                    // Swiped Right -> Prev
                    if (currentIndex > 0) navigate(-1);
                }
            }
        }

        // --- Keyboard Navigation (Desktop) ---
        document.addEventListener('keydown', (e) => {
            if (!document.body.classList.contains('has-active-story')) return;

            if (e.key === 'ArrowRight' || e.key === 'ArrowDown') navigate(1);
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') navigate(-1);
            if (e.key === 'Escape') closeStory();
        });

        // --- Magnetic Button Effect ---
        const startBtn = document.getElementById('start-btn');

        startBtn.addEventListener('mousemove', (e) => {
            if (document.body.classList.contains('has-active-story')) return;

            const rect = startBtn.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const centerX = rect.width / 2;
            const centerY = rect.height / 2;

            const deltaX = (x - centerX) / 5;
            const deltaY = (y - centerY) / 5;

            // Note: start-btn default transform is translateX(-50%)
            startBtn.style.transform = `translateX(calc(-50% + ${deltaX}px)) translateY(${deltaY}px) scale(1.02)`;
        });

        startBtn.addEventListener('mouseleave', () => {
             startBtn.style.transform = '';
        });
    </script>
</body>
</html>
